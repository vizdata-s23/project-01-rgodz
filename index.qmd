---
title: "Project title"
subtitle: "STA/ISS 313 - Project 1"
author: "Team Name"
format: html
editor: visual
---

```{r}
#| label: load-pkgs
#| message: false
#| warning: false

library(tidyverse)
library(dplyr)
library(stringr)
library(ggimage)
library(countrycode)
```

```{r}
#| label: load-data
#| message: false

matches <- read.csv("data/wcmatches.csv")
wc <- read.csv("data/worldcups.csv")
```

## Abstract

(1 paragraph): Project abstract.

------------------------------------------------------------------------

## Introduction

(1-2 paragraphs): Brief introduction to the dataset. You may repeat some of the information about the dataset provided in the introduction to the dataset on the TidyTuesday repository, paraphrasing on your own terms. Imagine that your project is a standalone document and the grader has no prior knowledge of the dataset.

## Question 1: Goals per match by tournament stage over time

## Introduction

#### How has the total number of goals scored in a match changed over time, and does the round in which a match is played correlate with the total number of goals scored in a match?

This question asks two questions in one. The first one deals with the total amount of goals scored during a match and how this has either increased, decreased, or stayed constant throughout the years. The second part of this question looks to see if the round that a match is played in has any association with the goal tally of that game.

The parts of the `matches` dataset that are necessary are the variables `home_score`, `away_score`, `year`, and `stage`. We will have to create a new variable that can be called `total_goals` that is the sum of `home_score` and `away_score` since we are interested in the number of goals scored per match. Also, we will have to do some data manipulation with the `stage` variable so that all group stage games are under the same category, as they currently have different names based on the group name (i.e. "Group A", "Group B", etc.) but are all a part of the same round of a World Cup. No external data is needed for this analysis. By answering this question we may be able to discern whether or not World Cup teams play a more conservative scheme as they get deeper in the tournament, as well as whether or not competing teams have become more or less attack-minded by looking at mean goals per match over time.

### Approach

For our visualization, we will create a violin plot for the distribution of goals scored for each year that is faceted by the round. So year will be on the x-axis and goals scored will be on the y-axis with each plot showing the distribution of the data points that came from a specific stage in the tournament. We will need to reorder the points so that the order of the faceted plots makes sense in context (such that the first plot shows the group stage distributions and the final round will be the last plot).

Following a suggestion from one of our peer reviews, for our second visualization to answer this question we will create a line plot with the average number of goals scored per game as the y-axis variable and year on the x-axis, separated by which round of the tournament. The chart would have different lines colored by tournament stage and display the change in average goals scored per game over the years for each round of the World Cup. This should give us a better sense of how goals scored per match differs by year and round on average as opposed to looking at the actual distributions in the violin plots.

### Analysis

```{r}
#| label: data-manipulation
matches_q1 <- matches %>%
  filter(stage != "Third place") |> #Third place game dropped from analysis due to teams lacking competitive edge
  mutate(
    stage = if_else(
      str_detect(stage, "Group"),
      "Group Stage",
      if_else(str_detect(stage, "Final"), "Final", stage)
    ),
    total_score = home_score + away_score
  ) |>
  mutate(year_group = if_else(
    year <= 1962,
    "1930 - 1962",
    if_else(year <= 1990, "1966 - 1990", "1994-2018")
  ))
```

```{r}
#| label: Q1-viz-1
matches_q1 |>
  group_by(year, stage) |>
  summarize(goals = mean(total_score)) |>
  ggplot(aes(x = year, y = goals, color = stage)) +
  geom_point() +
  geom_line() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) +
  theme(axis.text.x = element_text(
    angle = 50,
    vjust = 1,
    hjust = 1
  )) +
  scale_x_continuous(
    breaks = c(
      1930,
      1934,
      1938,
      1950,
      1954,
      1958,
      1962,
      1966,
      1970,
      1974,
      1978,
      1982,
      1986,
      1990,
      1994,
      1998,
      2002,
      2006,
      2010,
      2014,
      2018
    ),
    labels = c(
      "1930",
      "1934",
      "1938",
      "1950",
      "1954",
      "1958",
      "1962",
      "1966",
      "1970",
      "1974",
      "1978",
      "1982",
      "1986",
      "1990",
      "1994",
      "1998",
      "2002",
      "2006",
      "2010",
      "2014",
      "2018"
    )
  ) +
  theme(legend.key = element_rect(fill = "white", color = NA)) +
  scale_color_discrete(limits = c(
    "Group Stage",
    "Round of 16",
    "Quarterfinals",
    "Semifinals",
    "Final"
  )) +
  labs(
    title = "Mean goals per match in World Cup matches over time",
    subtitle = "By stage of tournament",
    x = "Year",
    y = "Mean goals per match",
    color = "Tournament stage"
  )
```

```{r}
#| label: Q1-viz-2
matches_q1 |>
  group_by(stage, year_group) |>
  summarize(goals = mean(total_score)) |>
  ggplot(aes(x = stage, y = goals, fill = stage)) +
  facet_wrap( ~ year_group) +
  geom_col() +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) +
  theme(axis.text.x = element_text(
    angle = 50,
    vjust = 1,
    hjust = 1
  )) +
  scale_fill_discrete(limits = c(
    "Group Stage",
    "Round of 16",
    "Quarterfinals",
    "Semifinals",
    "Final"
  )) +
  theme(legend.position = "none") +
  scale_x_discrete(limits = c(
    "Group Stage",
    "Round of 16",
    "Quarterfinals",
    "Semifinals",
    "Final"
  )) +
  labs(
    title = "Mean goals per match in World Cup stages",
    subtitle = "By time period",
    x = "Tournament Stage",
    y = "Mean goals per match",
    fill = "Tournament Stage"
  )
```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.

The objective of our analysis for this first question was to gain a better understanding of the relationship (if any) between the amount of goals scored in a match and which round of the World Cup said match is played. Taking this a step further, our team thought it useful to see if there existed any trends in this relationship that may have fluctuated over time. In our analysis, we decided to discard observations pertaining to the `Third place` stage of the tournament as this match is played after the two competing countries have already been eliminated from championship contention. Thus, it is understood that both sides would be less likely to play with the same competitive edge in a consolation game which may skew the result. Furthermore, we were required to perform some string manipulation in order to ensure uniform labels in the `stage` variable (i.e., `Group stage`, `Final`).

As displayed above in the analysis section, our team's first plot depicts a multiple line graph showing the change in mean goals per match over time by stage of the tournament (distinguished by line and point color). When our group first asked this question, we thought we might observe trends like more goals being scored in group stage matches due to higher likelihood of mismatched opponents or team's becoming more conservative in the later rounds as they face increasingly threatening opposition. However, from this first plot it is challenging to discern any concrete trends as far as goal tallies altering by tournament stage. We are able to note that the goals per match metric seems to be most consistent in the `Group stage` (teetering between 2 and 3 for much of the tournament's tenure) which makes sense as this marks the first round of the tournament including the highest amount of matches (observations) which contributes to less variability. If we were to remove the 2018 final from our plot, it would be more clear that goals per match across all stages of the tournament seem to be decreasing overall from 1930 to 2018. The 2018 final marks the exceptionally high scoring and not so back and forth match between France and Croatia which ended in a 4-2 French victory. It should be noted that the tournament's format has experienced changes throughout its history thus not every year contains an observation for all five stages. For example, the 1930 tournament featured only 13 countries while the 1974 and 1978 tournaments incorporated a unique format with 16 teams and two group stages. The years of 1942 and 1946 are void and left off of our plot as the tournament was cancelled due to World War II.

The second visualization which we have used to answer our question is a group of bar charts faceted by time period using a variable we created called `year_group`. The variable `year_group` chronologically divides the observations into three eras, each made up of seven World Cups, with the intention of depicting scoring trends in a more clustered fashion. When the data is visualized in this fashion, it becomes more clear that overall goals per match seems to be on a gradual decline from time period to time period. The tournaments from 1930 - 1962 appear to have had the highest goals per match of the three eras with the round of 16, semifinal, and final all seeing an entertaining five goals per match. Tournaments held between 1966 - 1990 saw a drop off in goals per match in each respective stage in comparison with earlier editions of the Cup. We are able to see that during this time period, goals per match increased as teams got deeper into the tournament as seen from the steady incline from the group stage to the final. More recent installments of the World Cup, as included in the 1994 - 2018 time period, also show a decline in goals per match in almost every single stage. It is also apparent that goals per match steadily decreased as teams made it deeper into the tournament with the later rounds seeing fewer goals compared with their earlier counterparts. This visualization may lead us to believe that teams used to be more attacking-oriented but have adjusted their schemes over time to be more conservative and defensively-focused. Of course, we are unable to necessarily make any conclusions just yet as to whether that is the truth or not, but this visualization does lead us to believe that goals per match have declined over time and that defenses may have become more talented or the pace of the game has shifted over time.

## Question 2: Title that relates to the question you're answering

### Introduction

(1-2 paragraphs): Introduction to the question and what parts of the dataset are necessary to answer the question. Also discuss why you're interested in this question.

This question has two parts. The first part asks about using a country's amount of semi-final appearances to measure success over all the years the FIFA World Cup has existed. The second part measures the same variable but instead of using semi-final appearances to measure this, it uses goal differential.

The parts of the dataset that are necessary are the variables `winner`, `second`, `third`, and `fourth` from the `wc` dataset. We will also use the `team_score` column the `opponent_score` column from the `matches` dataset to create a new column called `goal_differential`.

We are interested in this question because we were curious as to whether the amount of goals scored in a home game versus an away game affected how a country placed. Based off peer review feedback, we learned that others were also very interested in this topic and then modified our question based on the feedback.

#### Over the course of the FIFA World Cup's tenure, which nations have had the most success aggregated across all tournaments from 1930 to 2018 when considering semi-final appearances and overall goal differential?

### Approach

(1-2 paragraphs): Describe what types of plots you are going to make to address your question. For each plot, provide a clear explanation as to why this plot (e.g. boxplot, barplot, histogram, etc.) is best for providing the information you are asking about. The two plots should be of different types, and at least one of the two plots needs to use either color mapping or facets.

We will create two visualizations ranking participating nations on their all-time World Cup performance. For our first visualization, we will be looking at the variables `winner`, `second`, `third`, and `fourth` from the `wc` dataset. We will count the amount of times from 1930 to 2018 that individual countries have made it into the top four teams of the tournament, indicated by being listed as `winner`, `second`, `third`, and `fourth` in the `wc` dataset. This count will manifest as the plot's x-axis with country names in descending order on the y-axis. This visualization will give us a sense of which teams have had the most success with deep runs in the tournament over time.

To answer the second part of our question we will be using data from the `matches` dataset. In order to analyze each country's goal differential we must first do some data manipulation. First, we need to pivot the dataframe of matches longer so that each match now has two rows, with one the home and away columns being switched to team and opponent ones so that every second row is the same as the row before it in the opposite order. In case this is unclear, for example if there was a match in which Spain lost to Morocco 1-2, the first row would contain 1 under the `team_score` column and 2 under the `opponent_score` column and the following row would contain 2 under the `team_score` column and 1 under the `opponent_score` column. Then, goal differential will be calculated as `team_score` - `opponent_score`. Lastly, we will group the table by country and summarize using the sum of the new `goal_differential` column to be the dataframe we use in our analysis. The visualization will be faceted by country (descending order based on aggregate goal differential) and include a collection of line graphs using `geom_line()` that tracks each nation's goal differential in each World Cup with the new goal differential variable on the y-axis and the year of each World Cup on the x-axis. This visualization will give us a sense of which team's have the highest overall goal differential while also being able to gauge how that has varied from tournament to tournament over time by country.

### Analysis

(2-3 code blocks, 2 figures, text/code comments as needed): In this section, provide the code that generates your plots. Use scale functions to provide nice axis labels and guides. You are welcome to use theme functions to customize the appearance of your plot, but you are not required to do so. All plots must be made with **ggplot2**. Do not use base R or lattice plotting functions.

```{r}
#| label: data-manipulation-2

matches_q2 <- matches %>%
    pivot_longer(
    cols = c("home_team", "away_team"),
    names_to = "home_away",
    values_to = "team"
  ) %>%
  mutate(goal_differential = if_else(
    home_away == "home_team",
    home_score - away_score,
    away_score - home_score),
    won = if_else(winning_team == team, TRUE, FALSE, missing = FALSE)) %>%
  group_by(team) %>%
  summarise(total_goal_diff = sum(goal_differential),
            total_games = n(),
            win_perc = sum(won) / total_games) |>
  mutate(team = if_else(team == "United States", "USA", team))

wc_q2 <- wc %>%
    pivot_longer(
    cols = c("winner", "second", "third", "fourth"),
    names_to = "placement",
    values_to = "team"
  )
```

```{r}
#| label: Q2-viz

q2_data <- wc_q2 |>
  left_join(matches_q2, by = 'team')

q2_data |>
  group_by(team) |>
  summarise(appearances = n(), goal_diff = total_goal_diff) |>
  arrange(desc(appearances)) |>
  unique() |>
  filter(appearances > 2) |>
  ggplot(aes(x=appearances, y=team, fill=goal_diff)) +
  geom_col()


matches_q2 |>
  ggplot(aes(x=total_goal_diff, y=win_perc, size=total_games)) +
  geom_point()

```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.

#### 
