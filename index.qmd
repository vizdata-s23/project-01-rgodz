---
title: "Project title"
subtitle: "STA/ISS 313 - Project 1"
author: "RGodz"
format: html
editor: visual
execute: 
  echo: false
  warning: false
---

```{r}
#| label: load-pkgs
#| message: false
#| warning: false

library(tidyverse)
library(dplyr)
library(stringr)
library(ggrepel)
library(scales)
```

```{r}
#| label: load-data
#| message: false

matches <- read.csv("data/wcmatches.csv")
wc <- read.csv("data/worldcups.csv")
```

## Project Introduction

Our data visualization team, RGodz, has elected to use the FIFA World Cup data for our investigation. The 2022 World Cup recently came to a close in Qatar and was full of sensational story lines between FIFA's corruption leading up to the event, the likely end to Cristiano Ronaldo's international football career, and Lionel Messi's fairy-tale victory in the final against a star studded French side led by Kylian Mbappe. Considering all of the sensational headlines and buzz generated by this most recent installment of the World Cup, our team thought this data would be particularly exciting and relevant to analyze.

This [FIFA World Cup data](https://www.kaggle.com/datasets/evangower/fifa-world-cup) was made available on Kaggle by user Evan Gower. The data is broken up into two datasets which we have renamed to `matches` and `wc` . It should be noted that while the most recent World Cup has sparked our interest in the data, the 2022 World Cup data is not included in these datasets.

------------------------------------------------------------------------

## Question 1: Goals per match by tournament stage over time

### Introduction

#### How has the total number of goals scored in a match changed over time, and does the round in which a match is played correlate with the total number of goals scored in a match?

This question asks two questions in one. The first one deals with the total amount of goals scored during a match and how this has either increased, decreased, or stayed constant throughout the years. The second part of this question looks to see if the round that a match is played in has any association with the goal tally of that game.

The parts of the `matches` dataset that are necessary are the variables `home_score`, `away_score`, `year`, and `stage`. We will have to create a new variable that can be called `total_goals` that is the sum of `home_score` and `away_score` since we are interested in the number of goals scored per match. Also, we will have to do some data manipulation with the `stage` variable so that all group stage games are under the same category, as they currently have different names based on the group name (i.e. "Group A", "Group B", etc.) but are all a part of the same round of a World Cup. No external data is needed for this analysis. By answering this question we may be able to discern whether or not World Cup teams play a more conservative scheme as they get deeper in the tournament, as well as whether or not competing teams have become more or less attack-minded by looking at mean goals per match over time.

### Approach

Following a suggestion from one of our peer reviews, for our first visualization to answer this question we will create a line plot with the average number of goals scored per game as the y-axis variable and year on the x-axis, separated by which round of the tournament. The chart would have different lines colored by tournament stage and display the change in average goals scored per game over the years for each round of the World Cup. This should give us a better sense of how goals scored per match differs by year and round on average as opposed to looking at the actual distributions in the violin plots.

For our second visualization, we will create a bar plot for the distribution of goals scored for each round that is grouped by the time period. So the round will be on the x-axis and goals scored will be on the y-axis with each plot showing the distribution of the data points that came from a specific time period in the tournament. We will separate the time periods into three groups (1930 - 1962, 1966 - 1990, 1994 - 2018).

### Analysis

```{r}
#| label: data-manipulation
matches_q1 <- matches |>
  filter(stage != "Third place") |> # Third place game dropped from analysis due to teams lacking competitive edge
  mutate(
    stage = if_else(
      str_detect(stage, "Group"),
      "Group Stage",
      if_else(str_detect(stage, "Final"), "Final", stage)
    ),
    total_score = home_score + away_score
  ) |>
  # Put years into 3 groups for plotting purposes
  mutate(year_group = if_else(
    year <= 1962,
    "1930 - 1962",
    if_else(year <= 1990, "1966 - 1990", "1994-2018")
  ))
```

```{r}
#| label: Q1-viz-1
#| fig-cap: Figure 1
matches_q1 |>
  group_by(year, stage) |>
  summarize(goals = mean(total_score)) |>
  ggplot(aes(x = year, y = goals, color = stage)) +
  geom_point() +
  geom_line() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) +
  # Change axis label angles so its more readable
  theme(axis.text.x = element_text(
    angle = 50,
    vjust = 1,
    hjust = 1
  )) +
  # Set breaks for every tournament year
  scale_x_continuous(
    breaks = c(
      1930,
      1934,
      1938,
      1950,
      1954,
      1958,
      1962,
      1966,
      1970,
      1974,
      1978,
      1982,
      1986,
      1990,
      1994,
      1998,
      2002,
      2006,
      2010,
      2014,
      2018
    ),
    labels = c(
      "1930",
      "1934",
      "1938",
      "1950",
      "1954",
      "1958",
      "1962",
      "1966",
      "1970",
      "1974",
      "1978",
      "1982",
      "1986",
      "1990",
      "1994",
      "1998",
      "2002",
      "2006",
      "2010",
      "2014",
      "2018"
    )
  ) +
  theme(legend.key = element_rect(fill = "white", color = NA)) +
  # Color by round
  scale_color_discrete(limits = c(
    "Group Stage",
    "Round of 16",
    "Quarterfinals",
    "Semifinals",
    "Final"
  )) +
  labs(
    title = "Mean goals per match in World Cup matches over time",
    subtitle = "By stage of tournament",
    x = "Year",
    y = "Mean goals per match",
    color = "Tournament stage"
  )
```

```{r}
#| label: Q1-viz-2
#| fig-cap: Figure 2

matches_q1 |>
  group_by(stage, year_group) |>
  summarize(goals = mean(total_score)) |>
  ggplot(aes(x = stage, y = goals, fill = stage)) +
  facet_wrap(~ year_group) +
  geom_col() +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) +
  # Same angle change for readability
  theme(axis.text.x = element_text(
    angle = 50,
    vjust = 1,
    hjust = 1
  )) +
  # Same colors set by round
  scale_fill_discrete(limits = c(
    "Group Stage",
    "Round of 16",
    "Quarterfinals",
    "Semifinals",
    "Final"
  )) +
  # Remove redundant legend
  theme(legend.position = "none") +
  scale_x_discrete(limits = c(
    "Group Stage",
    "Round of 16",
    "Quarterfinals",
    "Semifinals",
    "Final"
  )) +
  labs(
    title = "Mean goals per match in World Cup stages",
    subtitle = "By time period",
    x = "Tournament Stage",
    y = "Mean goals per match",
    fill = "Tournament Stage"
  )
```

### Discussion

The objective of our analysis for this first question was to gain a better understanding of the relationship (if any) between the amount of goals scored in a match and which round of the World Cup said match is played. Taking this a step further, our team thought it useful to see if there existed any trends in this relationship that may have fluctuated over time. In our analysis, we decided to discard observations pertaining to the `Third place` stage of the tournament as this match is played after the two competing countries have already been eliminated from championship contention. Thus, it is understood that both sides would be less likely to play with the same competitive edge in a consolation game which may skew the result. Furthermore, we were required to perform some string manipulation in order to ensure uniform labels in the `stage` variable (i.e., `Group stage`, `Final`).

As displayed above in the analysis section, our team's first plot depicts a multiple line graph showing the change in mean goals per match over time by stage of the tournament (distinguished by line and point color). When our group first asked this question, we thought we might observe trends like more goals being scored in group stage matches due to higher likelihood of mismatched opponents or team's becoming more conservative in the later rounds as they face increasingly threatening opposition. However, from this first plot it is challenging to discern any concrete trends as far as goal tallies altering by tournament stage. We are able to note that the goals per match metric seems to be most consistent in the `Group stage` (teetering between 2 and 3 for much of the tournament's tenure) which makes sense as this marks the first round of the tournament including the highest amount of matches (observations) which contributes to less variability. If we were to remove the 2018 final from our plot, it would be more clear that goals per match across all stages of the tournament seem to be decreasing overall from 1930 to 2018. The 2018 final marks the exceptionally high scoring and not so back and forth match between France and Croatia which ended in a 4-2 French victory. It should be noted that the tournament's format has experienced changes throughout its history thus not every year contains an observation for all five stages. For example, the 1930 tournament featured only 13 countries while the 1974 and 1978 tournaments incorporated a unique format with 16 teams and two group stages. The years of 1942 and 1946 are void and left off of our plot as the tournament was cancelled due to World War II.

The second visualization which we have used to answer our question is a group of bar charts faceted by time period using a variable we created called `year_group`. The variable `year_group` chronologically divides the observations into three eras, each made up of seven World Cups, with the intention of depicting scoring trends in a more clustered fashion. When the data is visualized in this fashion, it becomes more clear that overall goals per match seems to be on a gradual decline from time period to time period. The tournaments from 1930 - 1962 appear to have had the highest goals per match of the three eras with the round of 16, semifinal, and final all seeing an entertaining five goals per match. Tournaments held between 1966 - 1990 saw a drop off in goals per match in each respective stage in comparison with earlier editions of the Cup. We are able to see that during this time period, goals per match increased as teams got deeper into the tournament as seen from the steady incline from the group stage to the final. More recent installments of the World Cup, as included in the 1994 - 2018 time period, also show a decline in goals per match in almost every single stage. It is also apparent that goals per match steadily decreased as teams made it deeper into the tournament with the later rounds seeing fewer goals compared with their earlier counterparts. This visualization may lead us to believe that teams used to be more attacking-oriented but have adjusted their schemes over time to be more conservative and defensively-focused. Of course, we are unable to necessarily make any conclusions just yet as to whether that is the truth or not, but this visualization does lead us to believe that goals per match have declined over time and that defenses may have become more talented or the pace of the game has shifted over time.

## Question 2: Country Success over Time

### Introduction

#### Over the course of the FIFA World Cup's tenure, which nations have had the most success aggregated across all tournaments from 1930 to 2018 when considering semi-final appearances and overall goal differential?

This question has two parts. The first part asks about using a country's amount of semi-final appearances to measure success over the FIFA World Cup's tenure. The second part also seeks to measure success but instead of using semi-final appearances to measure this, it uses goal differential.

The parts of the dataset that are necessary are the variables `winner`, `second`, `third`, and `fourth` from the `wc` dataset. We will also use the `team_score` column the `opponent_score` column from the `matches` dataset to create a new column called `goal_differential`.

We are interested in this question because measuring success in the World Cup and ranking countries outside of championship tallies is not an objective task. However, our team is looking for a way in which we can best depict country performance over time by looking at both a result metric (semifinal appearances) and a performance metric (goal differential). Based off peer review feedback, we learned that others were also very interested in this topic and then modified our question based on the feedback.

### Approach

We will create two visualizations ranking participating nations on their all-time World Cup performance. For our first visualization, we will make a sideways bar plot looking at the variables winner, second, third, and fourth from the wc dataset. We will count the amount of times from 1930 to 2018 that individual countries have made it into the top four teams of the tournament, indicated by being listed as winner, second, third, and fourth in the wc dataset. This count will manifest as the plot's x-axis with country names in descending order on the y-axis. We will then use a color gradient that is based on the goal differential. In order to analyze each country's goal differential we must first do some data manipulation. First, we need to pivot the dataframe of matches longer so that each match now has two rows, with the home and away columns being switched to team and opponent ones so that every second row is the same as the row before it in the opposite order. In case this is unclear, for example if there was a match in which Spain lost to Morocco 1-2, the first row would contain 1 under the team_score column and 2 under the opponent_score column and the following row would contain 2 under the team_score column and 1 under the opponent_score column. Then, goal differential will be calculated as team_score - opponent_score. This visualization will give us a sense of which teams have had the most success with deep runs in the tournament over time.

To answer the second part of our question we will be using data from the matches dataset. We will group the table by country and summarize using the sum of the new goal_differential column to be the dataframe we use in our analysis. The visualization will be a scatterplot depicting countries based on aggregate goal differential and use size and color of each point to track each nation's goal differential in each World Cup with the new goal differential variable on the x-axis and the winning percentage on the y-axis. This visualization will give us a sense of how strong or weak the correlation is between a team's winning percentage and their goal differential while also being able to gauge how that has varied between countries.

### Analysis

```{r}
#| label: data-manipulation-2
matches_q2 <- matches |>
  # Pivot as described above so there's two rows for each game played
  pivot_longer(
    cols = c("home_team", "away_team"),
    names_to = "home_away",
    values_to = "team"
  ) |>
  # Add in goal differential
  mutate(
    goal_differential = if_else(
      home_away == "home_team",
      home_score - away_score,
      away_score - home_score
    ),
    won = if_else(winning_team == team, TRUE, FALSE, missing = FALSE)
  ) |>
  group_by(team) |>
  # Get total goal differential and calculate winning percentage
  summarise(
    total_goal_diff = sum(goal_differential),
    total_games = n(),
    win_perc = sum(won) / total_games
  ) |>
  mutate(team = if_else(team == "United States", "USA", team))


wc_q2 <- wc |>
  # Pivot so easy to group by number of appearances in top 4
  pivot_longer(
    cols = c("winner", "second", "third", "fourth"),
    names_to = "placement",
    values_to = "team"
  )
```

```{r}
#| label: Q2-viz-1
#| fig-cap: Figure 3

q2_data <- wc_q2 |>
  left_join(matches_q2, by = 'team')

q2_data |>
  group_by(team) |>
  summarise(appearances = n(), goal_diff = total_goal_diff) |>
  arrange(desc(appearances)) |>
  # Use unique to get only one row for each team that has the info we want to plot
  unique() |>
  # Only plot teams who have made more than one semifinal to not overcrowd the plot
  filter(appearances > 2) |>
  ggplot(aes(
    x = appearances,
    y = reorder(team, goal_diff),
    fill = goal_diff
  )) +
  geom_col(show.legend = FALSE) +
  labs(
    title = "Goal differential has a positive correlation
       with final four appearances",
    subtitle = "Color scaled by goal differential (listed after each bar)",
    x = "Final four appearances",
    y = ""
  ) +
  theme_minimal() +
  scale_fill_gradient2(
    low = "lightblue",
    mid = "blue",
    high = "darkblue",
    midpoint = 50
  ) +
  # Add in goal differential numbers
  geom_text(
    aes(x = appearances + 0.5, y = team, label = goal_diff),
    size = 3,
    color = "black",
    fontface = 'bold'
  ) +
  scale_x_continuous(
    breaks = c(3,
               4,
               5,
               6,
               7,
               8,
               9,
               10,
               11),
    labels = c("3",
               "4",
               "5",
               "6",
               "7",
               "8",
               "9",
               "10",
               "11")
  ) +
  theme(
    plot.subtitle = element_text(size = 10),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_blank()
  )
```

```{r}
#| label: q2-viz2
#| fig-cap: Figure 4

matches_q2 |>
  # Remove teams who have not played in at least two tournaments
  filter(total_games > 6) |>
  ggplot(aes(
    x = total_goal_diff,
    y = win_perc,
    size = total_games,
    color = total_games
  )) +
  geom_point(show.legend = FALSE) +
  geom_text_repel(
    aes(label = ifelse(
      total_games >= 40 |
        total_goal_diff >= 25, team, ""
    )),
    size = 3,
    fontface = 'bold',
    color = "forestgreen"
  ) +
  labs(
    title = "Strong positive correlation between \n goal differential and winning percentage",
    x = "Total Goal Differential",
    y = "Winning Percentage",
    size = "Total Games Played",
    subtitle = "Size and color by total games played"
  ) +
  theme_minimal() +
  scale_color_gradient2(
    low = "lightblue",
    mid = "blue",
    high = "darkblue",
    midpoint = 50
  ) +
  scale_y_continuous(labels = percent_format())
```

### Discussion

#### 
